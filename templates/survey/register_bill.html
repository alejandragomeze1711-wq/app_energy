<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Factura</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ static('src/output.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="[background:#212332] text-white">
<main id="app">
    {% include "layouts/header.html" ignore missing %}
    {% include "layouts/sidebar.html" ignore missing %}
    <div class="[grid-area:main][background:#2A2D3E] p-4">
        <h1 class="text-3xl font-bold mb-6">Registrar Factura Mensual</h1>

        <!-- Formulario -->
        <form method="post" class="mb-6">
            {{ csrf_input }}
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <!-- AÑO -->
                <div>
                    <label class="text-white">Año</label>
                    <select name="year" 
                            class="w-full py-1.5 px-3 rounded-md bg-[#212332] text-black border border-[#605BFF] focus:outline-none focus:ring-2 focus:ring-[#605BFF] transition"
                            required>
                        {% for y in years %}
                            <option value="{{ y }}" {% if current_year == y %}selected{% endif %} class="text-black">{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- MES -->
                <div>
                    <label class="text-white">Mes</label>
                    <select name="month" 
                            class="w-full py-1.5 px-3 rounded-md bg-[#212332] text-black border border-[#605BFF] focus:outline-none focus:ring-2 focus:ring-[#605BFF] transition"
                            required>
                        {% for m_num, m_name in months %}
                            <option value="{{ m_num }}" {% if current_month == m_num %}selected{% endif %} class="text-black">{{ m_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- VALOR -->
                <div>
                    <label class="text-white">Valor de la factura (COP)</label>
                    <input type="number" step="0.01" name="amount" placeholder="Ej. 150000"
                        class="w-full py-1.5 px-3 rounded-md bg-[#212332] text-black border border-[#605BFF] focus:outline-none focus:ring-2 focus:ring-[#605BFF] transition"
                        required>
                </div>
            </div>
            <button type="submit" class="py-1.5 px-4 bg-[#605BFF] rounded-md">Guardar Factura</button>
        </form>

        <!-- Mensajes -->
        {% if messages %}
            {% for message in messages %}
                <div class="mb-4 p-2 rounded {% if 'error' in message.tags %}bg-red-800{% else %}bg-green-800{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Gráfica -->
        <div class="mt-8 p-4 bg-[#212332] rounded-lg">
            <h2 class="text-xl font-bold mb-4 text-white">Histórico de Consumo</h2>
            <canvas id="billChart" width="400" height="200"></canvas>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('billChart').getContext('2d');

        // Hacer la petición AJAX para obtener los datos
        fetch('/survey/bill-chart-data/')
            .then(response => response.json())
            .then(data => {
                // Preparar los datos para Chart.js
                const labels = data.map(item => item.x); // Ej: "2025-11"
                const values = data.map(item => item.y); // El valor de la factura

                // Crear la gráfica
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Valor de Factura (COP)',
                            data: values,
                            backgroundColor: 'rgba(96, 91, 255, 0.2)', // Color de fondo (púrpura claro)
                            borderColor: '#605BFF', // Color de la línea (púrpura)
                            borderWidth: 2,
                            pointBackgroundColor: '#605BFF',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            tension: 0.4 // Suavizado de la línea
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                display: false // Ocultar la leyenda si solo tienes un dataset
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `Factura: $${context.raw.toLocaleString('es-CO')}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'Mes/Año'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'white' // Color del texto del eje X
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'Valor (COP)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: 'white', // Color del texto del eje Y
                                    callback: function(value) {
                                        return '$' + value.toLocaleString('es-CO');
                                    }
                                }
                            }
                        }
                    }
                });
            })
            .catch(error => {
                console.error('Error al cargar los datos de la gráfica:', error);
                // Opcional: Mostrar un mensaje de error en la UI
                const chartContainer = document.querySelector('#billChart').parentElement;
                chartContainer.innerHTML = '<p class="text-red-400">Error al cargar la gráfica. Por favor, inténtelo de nuevo.</p>';
            });
    });
</script>

</body>
</html>

</body>
</html>